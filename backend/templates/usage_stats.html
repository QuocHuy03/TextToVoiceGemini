<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice API - Usage Stats</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
        }
        .sidebar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }
        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.8);
            padding: 12px 20px;
            border-radius: 10px;
            margin: 5px 0;
            transition: all 0.3s;
        }
        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            color: white;
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }
        .main-content {
            padding: 2rem;
        }
        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            border-left: 4px solid;
            transition: transform 0.3s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .stat-card.users { border-left-color: #28a745; }
        .stat-card.keys { border-left-color: #007bff; }
        .stat-card.today { border-left-color: #ffc107; }
        .stat-card.month { border-left-color: #dc3545; }
        .stat-icon {
            font-size: 2.5rem;
            opacity: 0.7;
        }
        .chart-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 2rem;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 sidebar">
                <div class="p-3">
                    <h4 class="text-center mb-4">
                        <i class="fas fa-microphone-alt me-2"></i>
                        Voice API
                    </h4>
                    
                    <nav class="nav flex-column">
                        <a class="nav-link" href="/admin/dashboard" data-section="dashboard">
                            <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                        </a>
                        <a class="nav-link" href="/admin/users">
                            <i class="fas fa-users me-2"></i>Users
                        </a>
                        <a class="nav-link" href="/admin/keys">
                            <i class="fas fa-cogs me-2"></i>Key Management
                        </a>
                        <a class="nav-link" href="/admin/gemini-keys" data-section="gemini-keys">
                            <i class="fas fa-robot me-2"></i>Gemini Keys
                        </a>
                        <a class="nav-link active" href="/admin/usage" data-section="usage">
                            <i class="fas fa-chart-bar me-2"></i>Usage Stats
                        </a>
                        <a class="nav-link" href="{{ url_for('admin_logout') }}">
                            <i class="fas fa-sign-out-alt me-2"></i>Logout
                        </a>
                    </nav>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-md-9 col-lg-10 main-content">
                <!-- Stats Cards -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="stat-card today">
                            <div class="d-flex align-items-center">
                                <div class="flex-grow-1">
                                    <h3 class="mb-1" id="todayUsage">0</h3>
                                    <p class="mb-0 text-muted">Usage Hôm nay</p>
                                </div>
                                <div class="stat-icon text-warning">
                                    <i class="fas fa-chart-line"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card month">
                            <div class="d-flex align-items-center">
                                <div class="flex-grow-1">
                                    <h3 class="mb-1" id="monthUsage">0</h3>
                                    <p class="mb-0 text-muted">Usage Tháng này</p>
                                </div>
                                <div class="stat-icon text-danger">
                                    <i class="fas fa-chart-bar"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card users">
                            <div class="d-flex align-items-center">
                                <div class="flex-grow-1">
                                    <h3 class="mb-1" id="totalRequests">0</h3>
                                    <p class="mb-0 text-muted">Tổng Requests</p>
                                </div>
                                <div class="stat-icon text-success">
                                    <i class="fas fa-globe"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card keys">
                            <div class="d-flex align-items-center">
                                <div class="flex-grow-1">
                                    <h3 class="mb-1" id="avgDaily">0</h3>
                                    <p class="mb-0 text-muted">Trung bình/Ngày</p>
                                </div>
                                <div class="stat-icon text-primary">
                                    <i class="fas fa-calculator"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts Row -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="chart-card">
                            <h5 class="mb-3">
                                <i class="fas fa-chart-pie me-2"></i>Usage Distribution
                            </h5>
                            <canvas id="usageDistributionChart" height="300"></canvas>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="chart-card">
                            <h5 class="mb-3">
                                <i class="fas fa-chart-line me-2"></i>Daily Usage (7 ngày qua)
                            </h5>
                            <canvas id="dailyUsageChart" height="300"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Usage Logs Table -->
                <div class="chart-card">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="mb-0">
                            <i class="fas fa-list me-2"></i>Usage Logs (Gần đây)
                        </h5>
                        <div>
                            <button class="btn btn-primary me-2" onclick="loadUsageLogs()">
                                <i class="fas fa-refresh me-2"></i>Refresh
                            </button>
                            <button class="btn btn-danger" onclick="clearOldLogs()">
                                <i class="fas fa-trash me-2"></i>Clear Old Logs
                            </button>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>STT</th>
                                    <th>API Key</th>
                                    <th>User</th>
                                    <th>Text Length</th>
                                    <th>Voice</th>
                                    <th>Duration</th>
                                    <th>File Size</th>
                                    <th>IP Address</th>
                                    <th>Timestamp</th>
                                </tr>
                            </thead>
                            <tbody id="usageLogsTableBody">
                                <tr id="loadingLogsRow">
                                    <td colspan="9" class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <div class="mt-2">Đang tải dữ liệu...</div>
                                        <div class="mt-2">
                                            <button class="btn btn-outline-primary btn-sm" onclick="loadUsageLogs()">
                                                <i class="fas fa-refresh me-1"></i>Thử lại
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <nav aria-label="Usage logs pagination" class="mt-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="text-muted">
                                Hiển thị <span id="showingFromUsage">0</span> - <span id="showingToUsage">0</span> 
                                trong tổng số <span id="totalUsageLogs">0</span> logs
                            </div>
                            <ul class="pagination pagination-sm mb-0" id="usagePagination">
                                <!-- Pagination buttons will be generated here -->
                            </ul>
                        </div>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        console.log('Script starting...');
        
        // Load usage data
        let isLoadingLogs = false;
        let allUsageLogs = [];
        let currentUsagePage = 1;
        const usageItemsPerPage = 30;
        
        function loadUsageLogs() {
            if (isLoadingLogs) {
                console.log('Already loading logs, skipping...');
                return;
            }
            
            isLoadingLogs = true;
            console.log('Loading usage logs...');
            
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000);
            
            fetch('/api/admin/usage-logs', {
                signal: controller.signal
            })
                .then(response => {
                    clearTimeout(timeoutId);
                    console.log('Response status:', response.status);
                    
                    if (response.status === 403) {
                        console.log('Admin session required, redirecting to login...');
                        alert('Vui lòng đăng nhập admin trước!');
                        window.location.href = '/admin/login';
                        return;
                    }
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    return response.json();
                })
                .then(data => {
                    if (!data) return;
                    console.log('API response:', data);
                    
                    if (data.success) {
                        const logs = data.logs.map(log => ({
                            id: log.id,
                            apiKey: log.api_key,
                            username: log.username,
                            textLength: log.text_length,
                            voiceName: log.voice_name,
                            duration: log.duration,
                            fileSize: log.file_size,
                            ipAddress: log.ip_address,
                            timestamp: log.timestamp
                        }));
                        
                        console.log('Processed logs:', logs);
                        allUsageLogs = logs; // Store all logs
                        renderUsageLogsTable();
                        updateUsageStats(allUsageLogs);
                        updateCharts(allUsageLogs);
                        renderUsagePagination();
                    } else {
                        console.error('Failed to load logs:', data.error);
                        showLogsError('Không thể tải dữ liệu: ' + (data.error || 'Lỗi không xác định'));
                    }
                })
                .catch(error => {
                    clearTimeout(timeoutId);
                    console.error('Error loading logs:', error);
                    
                    if (error.name === 'AbortError') {
                        showLogsError('Timeout! Vui lòng kiểm tra kết nối mạng.');
                    } else {
                        showLogsError('Lỗi kết nối: ' + error.message);
                    }
                })
                .finally(() => {
                    isLoadingLogs = false;
                });
        }
        
        function showLogsError(message) {
            const tbody = document.getElementById('usageLogsTableBody');
            const loadingRow = document.getElementById('loadingLogsRow');
            if (loadingRow) {
                loadingRow.remove();
            }
            
            tbody.innerHTML = `
                <tr>
                    <td colspan="9" class="text-center py-4 text-danger">
                        <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                        <div>${message}</div>
                        <button class="btn btn-primary mt-2" onclick="loadUsageLogs()">
                            <i class="fas fa-refresh me-2"></i>Thử lại
                        </button>
                    </td>
                </tr>
            `;
        }

        function renderUsageLogsTable() {
            console.log('Rendering logs table with', allUsageLogs.length, 'total logs');
            const tbody = document.getElementById('usageLogsTableBody');
            console.log('Found tbody element:', tbody);
            
            const loadingRow = document.getElementById('loadingLogsRow');
            if (loadingRow) {
                loadingRow.remove();
            }
            
            tbody.innerHTML = '';

            if (allUsageLogs.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center py-4 text-muted">
                            <i class="fas fa-inbox fa-2x mb-2"></i>
                            <div>Không có usage logs nào</div>
                        </td>
                    </tr>
                `;
                return;
            }

            // Calculate pagination
            const startIndex = (currentUsagePage - 1) * usageItemsPerPage;
            const endIndex = Math.min(startIndex + usageItemsPerPage, allUsageLogs.length);
            const pageLogs = allUsageLogs.slice(startIndex, endIndex);

            pageLogs.forEach((log, index) => {
                console.log('Creating row for log:', log);
                const row = createLogRow(log, startIndex + index);
                tbody.appendChild(row);
            });
            
            console.log('Finished rendering logs table');
        }

        function renderUsagePagination() {
            const totalPages = Math.ceil(allUsageLogs.length / usageItemsPerPage);
            const paginationContainer = document.getElementById('usagePagination');
            const showingFrom = document.getElementById('showingFromUsage');
            const showingTo = document.getElementById('showingToUsage');
            const totalLogs = document.getElementById('totalUsageLogs');

            // Update showing info
            const startIndex = (currentUsagePage - 1) * usageItemsPerPage;
            const endIndex = Math.min(startIndex + usageItemsPerPage, allUsageLogs.length);
            
            showingFrom.textContent = allUsageLogs.length > 0 ? startIndex + 1 : 0;
            showingTo.textContent = endIndex;
            totalLogs.textContent = allUsageLogs.length;

            // Clear existing pagination
            paginationContainer.innerHTML = '';

            if (totalPages <= 1) {
                return; // No pagination needed
            }

            // Previous button
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentUsagePage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#" onclick="changeUsagePage(${currentUsagePage - 1})">Trước</a>`;
            paginationContainer.appendChild(prevLi);

            // Page numbers
            const startPage = Math.max(1, currentUsagePage - 2);
            const endPage = Math.min(totalPages, currentUsagePage + 2);

            if (startPage > 1) {
                const firstLi = document.createElement('li');
                firstLi.className = 'page-item';
                firstLi.innerHTML = `<a class="page-link" href="#" onclick="changeUsagePage(1)">1</a>`;
                paginationContainer.appendChild(firstLi);

                if (startPage > 2) {
                    const ellipsisLi = document.createElement('li');
                    ellipsisLi.className = 'page-item disabled';
                    ellipsisLi.innerHTML = `<span class="page-link">...</span>`;
                    paginationContainer.appendChild(ellipsisLi);
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === currentUsagePage ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#" onclick="changeUsagePage(${i})">${i}</a>`;
                paginationContainer.appendChild(li);
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const ellipsisLi = document.createElement('li');
                    ellipsisLi.className = 'page-item disabled';
                    ellipsisLi.innerHTML = `<span class="page-link">...</span>`;
                    paginationContainer.appendChild(ellipsisLi);
                }

                const lastLi = document.createElement('li');
                lastLi.className = 'page-item';
                lastLi.innerHTML = `<a class="page-link" href="#" onclick="changeUsagePage(${totalPages})">${totalPages}</a>`;
                paginationContainer.appendChild(lastLi);
            }

            // Next button
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentUsagePage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#" onclick="changeUsagePage(${currentUsagePage + 1})">Sau</a>`;
            paginationContainer.appendChild(nextLi);
        }

        function changeUsagePage(page) {
            const totalPages = Math.ceil(allUsageLogs.length / usageItemsPerPage);
            if (page < 1 || page > totalPages) return;
            
            currentUsagePage = page;
            renderUsageLogsTable();
            renderUsagePagination();
        }

        function createLogRow(log, index) {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><strong>${index + 1}</strong></td>
                <td><code>${log.apiKey.substring(0, 10)}...</code></td>
                <td><strong>${log.username}</strong></td>
                <td><span class="badge bg-info">${log.textLength}</span></td>
                <td><span class="badge bg-secondary">${log.voiceName}</span></td>
                <td><span class="badge bg-warning">${log.duration}s</span></td>
                <td><span class="badge bg-primary">${formatFileSize(log.fileSize)}</span></td>
                <td><code>${log.ipAddress}</code></td>
                <td>${formatDate(log.timestamp)}</td>
            `;
            return row;
        }

        function updateUsageStats(logs) {
            // Get Vietnam timezone dates
            const vietnamNow = new Date();
            vietnamNow.setHours(vietnamNow.getHours() + 7); // Convert to UTC+7
            const today = vietnamNow.toISOString().split('T')[0];
            const thisMonth = vietnamNow.toISOString().substring(0, 7);
            
            const todayLogs = logs.filter(log => log.timestamp.startsWith(today));
            const monthLogs = logs.filter(log => log.timestamp.startsWith(thisMonth));
            
            const todayUsage = todayLogs.length;
            const monthUsage = monthLogs.length;
            const totalRequests = logs.length;
            const avgDaily = totalRequests > 0 ? Math.round(totalRequests / 30) : 0;
            
            document.getElementById('todayUsage').textContent = todayUsage;
            document.getElementById('monthUsage').textContent = monthUsage;
            document.getElementById('totalRequests').textContent = totalRequests;
            document.getElementById('avgDaily').textContent = avgDaily;
        }

        function updateCharts(logs) {
            // Usage Distribution Chart
            const usageCtx = document.getElementById('usageDistributionChart').getContext('2d');
            new Chart(usageCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Hôm nay', 'Tháng này', 'Tổng cộng'],
                    datasets: [{
                        data: [
                            logs.filter(log => log.timestamp.startsWith(new Date().toISOString().split('T')[0])).length,
                            logs.filter(log => log.timestamp.startsWith(new Date().toISOString().substring(0, 7))).length,
                            logs.length
                        ],
                        backgroundColor: ['#ffc107', '#dc3545', '#28a745']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Daily Usage Chart (last 7 days)
            const dailyCtx = document.getElementById('dailyUsageChart').getContext('2d');
            const last7Days = [];
            const dailyCounts = [];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                last7Days.push(date.toLocaleDateString('vi-VN', { month: 'short', day: 'numeric' }));
                
                const dayLogs = logs.filter(log => log.timestamp.startsWith(dateStr));
                dailyCounts.push(dayLogs.length);
            }
            
            new Chart(dailyCtx, {
                type: 'bar',
                data: {
                    labels: last7Days,
                    datasets: [{
                        label: 'Usage',
                        data: dailyCounts,
                        backgroundColor: '#28a745'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function formatDate(dateString) {
            if (!dateString) return 'Chưa có';
            const date = new Date(dateString);
            // Convert to Vietnam timezone (UTC+7)
            const vietnamTime = new Date(date.getTime() + (7 * 60 * 60 * 1000));
            return vietnamTime.toLocaleString('vi-VN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function clearOldLogs() {
            if (!confirm('Bạn có chắc chắn muốn xóa các logs cũ? (Giữ lại 1000 logs gần nhất)')) {
                return;
            }

            fetch('/api/admin/usage-logs', {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Xóa logs cũ thành công!');
                    loadUsageLogs();
                } else {
                    alert('Lỗi: ' + (data.error || 'Không thể xóa logs'));
                }
            })
            .catch(error => {
                console.error('Error clearing logs:', error);
                alert('Lỗi kết nối!');
            });
        }

        // Auto-load usage logs when page loads
        console.log('Setting up auto-load for usage logs...');
        
        function autoLoadUsageLogs() {
            console.log('Auto-loading usage logs...');
            loadUsageLogs();
        }
        
        if (document.readyState === 'loading') {
            console.log('Document still loading, waiting for DOMContentLoaded...');
            document.addEventListener('DOMContentLoaded', autoLoadUsageLogs);
        } else {
            console.log('Document already ready, loading usage logs immediately...');
            autoLoadUsageLogs();
        }

        // Set active navigation based on current page
        function setActiveNavigation() {
            const currentPath = window.location.pathname;
            const navLinks = document.querySelectorAll('.sidebar .nav-link');
            
            navLinks.forEach(link => {
                link.classList.remove('active');
                const href = link.getAttribute('href');
                
                if (href === currentPath) {
                    link.classList.add('active');
                }
            });
        }

        // Set active navigation when page loads
        setActiveNavigation();
    </script>
</body>
</html>